;; Test Complete UTF-8 System
;; Demonstrates full Unicode support with collation

(println "=== Complete UTF-8 System Test ===")
(println)

;; Test data in various languages
(define test-strings
  '(;; English
    ("Hello" "hello" "HELLO")
    ;; French
    ("cafÃ©" "cafe" "CafÃ©")
    ("Ã©lÃ¨ve" "eleve" "Ã‰cole")
    ;; German
    ("MÃ¼ller" "Mueller" "Ã¼ber")
    ;; Spanish
    ("aÃ±o" "ano" "niÃ±o")
    ;; Chinese
    ("åŒ—äº¬" "ä¸Šæµ·" "ä¸­å›½")
    ;; Japanese
    ("ã“ã‚“ã«ã¡ã¯" "ã•ã‚ˆã†ãªã‚‰" "ã‚ã‚ŠãŒã¨ã†")
    ;; Korean
    ("ì•ˆë…•í•˜ì„¸ìš”" "ê°ì‚¬í•©ë‹ˆë‹¤" "í•œêµ­")
    ;; Arabic (RTL)
    ("Ù…Ø±Ø­Ø¨Ø§" "Ø´ÙƒØ±Ø§" "Ø¹Ø±Ø¨ÙŠ")
    ;; Hebrew (RTL)
    ("×©×œ×•×" "×ª×•×“×”" "×¢×‘×¨×™×ª")
    ;; Emoji
    ("ğŸ˜€" "ğŸŒ" "ğŸš€")
    ;; Mixed
    ("ABC123" "abc123" "123ABC")))

;; Simple string display with script detection
(define-function display-string-info (str)
  (println "String: \"" str "\"")
  (println "  Bytes: " (string-length str))
  (println "  Chars: " (utf8-char-count str))
  (println "  Script: " (detect-primary-script str)))

;; Detect primary script (simplified)
(define-function detect-primary-script (str)
  (let ((first-char (string-ref str 0)))
    (cond
      ((< first-char 128) 'latin)
      ((string-contains? str "ä¸­") 'chinese)
      ((string-contains? str "ã“") 'japanese)
      ((string-contains? str "í•œ") 'korean)
      ((string-contains? str "Ù…") 'arabic)
      ((string-contains? str "×©") 'hebrew)
      ((> first-char 127000) 'emoji)
      (else 'other))))

;; UTF-8 character count (vs byte count)
(define-function utf8-char-count (str)
  ;; Simplified - count UTF-8 start bytes
  (let ((count 0))
    (string-for-each
      (lambda (byte)
        (if (or (< byte 128)              ; ASCII
                (>= byte 192))            ; UTF-8 start byte
            (set count (+ count 1))))
      str)
    count))

;; Test basic properties
(println "1. Basic String Properties")
(println "--------------------------")
(display-string-info "Hello")
(display-string-info "ä½ å¥½")
(display-string-info "Ù…Ø±Ø­Ø¨Ø§")
(display-string-info "ğŸ‘‹ğŸŒ")
(println)

;; Test collation/sorting
(println "2. Collation Examples")
(println "---------------------")
(println "ASCII sort vs locale sort:")
(let ((words '("zebra" "Zebra" "apple" "Apple" "Ã©cole" "ecole")))
  (println "  Original: " words)
  (println "  ASCII: " (sort words string<?))
  (println "  Case-insensitive: " (sort words string-ci<?)))
(println)

;; Test normalization concepts
(println "3. Normalization Concepts")
(println "-------------------------")
(println "Precomposed vs Decomposed:")
(println "  Precomposed: Ã© (single character)")
(println "  Decomposed: Ã© (e + combining acute)")
(println "  Both should compare equal after normalization")
(println)

;; Test bidirectional text
(println "4. Bidirectional Text")
(println "---------------------")
(println "Mixed LTR/RTL:")
(println "  English: Hello (LTR)")
(println "  Arabic: Ù…Ø±Ø­Ø¨Ø§ (RTL)")
(println "  Hebrew: ×©×œ×•× (RTL)")
(println "  Mixed: Hello Ù…Ø±Ø­Ø¨Ø§ ×©×œ×•×")
(println)

;; Test script mixing
(println "5. Script Mixing")
(println "----------------")
(dolist (example '(("Hello ä½ å¥½" "English + Chinese")
                   ("ã“ã‚“ã«ã¡ã¯ ä¸–ç•Œ" "Japanese + Chinese")
                   ("CafÃ© å’–å•¡" "French + Chinese")
                   ("ğŸŒ World ä¸–ç•Œ" "Emoji + English + Chinese")))
  (println "  " (car example) " - " (cadr example)))
(println)

;; Performance test
(println "6. Performance Test")
(println "-------------------")
(let ((test-string "Hello ä½ å¥½ Ù…Ø±Ø­Ø¨Ø§ ğŸŒ")
      (iterations 1000))
  (println "String: \"" test-string "\"")
  (println "Operations: " iterations " iterations")
  
  (let ((start-time (current-time)))
    (dotimes (i iterations)
      (utf8-char-count test-string))
    (println "  Character counting: " (- (current-time) start-time) " seconds"))
  
  (let ((start-time (current-time)))
    (dotimes (i iterations)
      (string-length test-string))
    (println "  Byte counting: " (- (current-time) start-time) " seconds")))

(println)
(println "=== UTF-8 System Test Complete ===")