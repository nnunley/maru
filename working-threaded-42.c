=== Generating threaded program for 42 ===
[32m[?7lworking-threaded.l:28[0m (next-thread)
[?7h[32m[?7lworking-threaded.l:28[0m (let ((name (next-thread))) (add-forward-decl (concat-string "oop " (concat-string name "(thread_context *ctx);"))) (add-implementation (lambda () (println "oop " name "(thread_context *ctx) {") (print "    ctx->acc = LONG(" value ");") (println "    return " next-thread "(ctx);") (println "}"))) name)
[?7h[32m[?7lworking-threaded.l:66[0m (gen-literal-thread expr ret-thread)
[?7h[32m[?7lworking-threaded.l:65[0m (let ((main-thread (gen-literal-thread expr ret-thread))) (println "/* Threaded C Code */") (println "#include <stdio.h>") (println "#include <stdlib.h>") (println) (println "typedef void *oop;") (println "#define LONG(n) ((oop)(((long)(n) << 1) | 1))") (println "#define getLong(x) ((long)(x) >> 1)") (println) (println "typedef struct {") (println "    oop stack[1024];") (println "    oop *sp;") (println "    oop acc;") (println "} thread_context;") (println) (println "/* Forward declarations */") (let ((decls *forward-decls*)) (while decls (println (car decls)) (set decls (cdr decls)))) (println) (println "/* Thread implementations */") (let ((impls *implementations*)) (while impls (let ((impl (car impls))) (impl)) (println) (set impls (cdr impls)))) (println "int main() {") (println "    thread_context ctx = {0};") (println "    ctx.sp = ctx.stack;") (println "    oop result = " main-thread "(&ctx);") (println "    printf(\"Result: %ld\\n\", getLong(result));") (println "    return 0;") (println "}"))
[?7h[32m[?7lworking-threaded.l:65[0m (let ((ret-thread (gen-return-thread))) (let ((main-thread (gen-literal-thread expr ret-thread))) (println "/* Threaded C Code */") (println "#include <stdio.h>") (println "#include <stdlib.h>") (println) (println "typedef void *oop;") (println "#define LONG(n) ((oop)(((long)(n) << 1) | 1))") (println "#define getLong(x) ((long)(x) >> 1)") (println) (println "typedef struct {") (println "    oop stack[1024];") (println "    oop *sp;") (println "    oop acc;") (println "} thread_context;") (println) (println "/* Forward declarations */") (let ((decls *forward-decls*)) (while decls (println (car decls)) (set decls (cdr decls)))) (println) (println "/* Thread implementations */") (let ((impls *implementations*)) (while impls (let ((impl (car impls))) (impl)) (println) (set impls (cdr impls)))) (println "int main() {") (println "    thread_context ctx = {0};") (println "    ctx.sp = ctx.stack;") (println "    oop result = " main-thread "(&ctx);") (println "    printf(\"Result: %ld\\n\", getLong(result));") (println "    return 0;") (println "}")))
[?7h[32m[?7lworking-threaded.l:113[0m (gen-threaded-program 42)
[?7h