emit-c-threaded.l loaded - Unified Threaded C Backend
/* Threaded C Code Generated by Maru */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef void *oop;
#define nil ((oop)0)
#define LONG(n) ((oop)(((long)(n) << 1) | 1))
#define getLong(x) ((long)(x) >> 1)

typedef struct {
    oop stack[1024];    /* Value stack */
    oop *sp;            /* Stack pointer */
    oop locals[256];    /* Local variables */
    oop acc;            /* Accumulator */
} thread_context;

/* Runtime support functions */
oop lookup_var(const char *name, thread_context *ctx) {
    /* Variable lookup not implemented yet */
    return nil;
}


[31;1merror: Complex conditionals not yet supported[m

error: aborting
[32m[?7lboot2.l:24  [0m (abort)
[?7h[32m[?7lemit-c-threaded.l:195[0m (error "Complex conditionals not yet supported")
[?7h[32m[?7lemit-c-threaded.l:189[0m (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))
[?7h[32m[?7lemit-c-threaded.l:186[0m (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported")))
[?7h[32m[?7lemit-c-threaded.l:186[0m (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))
[?7h[32m[?7lemit-c-threaded.l:186[0m (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported")))))
[?7h[32m[?7lemit-c-threaded.l:177[0m (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op))
[?7h[32m[?7lemit-c-threaded.l:177[0m (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op)))
[?7h[32m[?7lemit-c-threaded.l:177[0m (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op))))
[?7h[32m[?7lemit-c-threaded.l:177[0m (if (= op (quote -)) (c-gen-binop-thread "-" (cadr expr) (caddr expr) next) (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op)))))
[?7h[32m[?7lemit-c-threaded.l:177[0m (if (= op (quote +)) (c-gen-binop-thread "+" (cadr expr) (caddr expr) next) (if (= op (quote -)) (c-gen-binop-thread "-" (cadr expr) (caddr expr) next) (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op))))))
[?7h[32m[?7lemit-c-threaded.l:176[0m (let ((op (car expr))) (if (= op (quote +)) (c-gen-binop-thread "+" (cadr expr) (caddr expr) next) (if (= op (quote -)) (c-gen-binop-thread "-" (cadr expr) (caddr expr) next) (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op)))))))
[?7h[32m[?7lemit-c-threaded.l:161[0m (if (pair? expr) (let ((op (car expr))) (if (= op (quote +)) (c-gen-binop-thread "+" (cadr expr) (caddr expr) next) (if (= op (quote -)) (c-gen-binop-thread "-" (cadr expr) (caddr expr) next) (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op))))))) (error "Unsupported expression type"))
[?7h[32m[?7lemit-c-threaded.l:161[0m (if (symbol? expr) (c-gen-variable-thread expr next) (if (pair? expr) (let ((op (car expr))) (if (= op (quote +)) (c-gen-binop-thread "+" (cadr expr) (caddr expr) next) (if (= op (quote -)) (c-gen-binop-thread "-" (cadr expr) (caddr expr) next) (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op))))))) (error "Unsupported expression type")))
[?7h[32m[?7lemit-c-threaded.l:161[0m (if (string? expr) (c-gen-string-thread expr next) (if (symbol? expr) (c-gen-variable-thread expr next) (if (pair? expr) (let ((op (car expr))) (if (= op (quote +)) (c-gen-binop-thread "+" (cadr expr) (caddr expr) next) (if (= op (quote -)) (c-gen-binop-thread "-" (cadr expr) (caddr expr) next) (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op))))))) (error "Unsupported expression type"))))
[?7h[32m[?7lemit-c-threaded.l:161[0m (if (long? expr) (c-gen-literal-thread expr next) (if (string? expr) (c-gen-string-thread expr next) (if (symbol? expr) (c-gen-variable-thread expr next) (if (pair? expr) (let ((op (car expr))) (if (= op (quote +)) (c-gen-binop-thread "+" (cadr expr) (caddr expr) next) (if (= op (quote -)) (c-gen-binop-thread "-" (cadr expr) (caddr expr) next) (if (= op (quote *)) (c-gen-binop-thread "*" (cadr expr) (caddr expr) next) (if (= op (quote /)) (c-gen-binop-thread "/" (cadr expr) (caddr expr) next) (if (= op (quote if)) (let ((test-expr (cadr expr))) (let ((then-expr (caddr expr))) (let ((else-expr (if (cdddr expr) (cadddr expr) (quote nil)))) (if (long? test-expr) (if (not (= test-expr 0)) (compile-expression then-expr next) (compile-expression else-expr next)) (error "Complex conditionals not yet supported"))))) (error "Unsupported operation: " op))))))) (error "Unsupported expression type")))))
[?7h[32m[?7lemit-c-threaded.l:264[0m (compile-expression expr ret-thread)
[?7h[32m[?7lemit-c-threaded.l:263[0m (let ((main-thread (compile-expression expr ret-thread))) (println "/* Forward declarations */") (let ((decls (my-reverse *thread-forward-decls*))) (while decls (println (car decls)) (set decls (cdr decls)))) (println) (println "/* Thread implementations */") (let ((impls (my-reverse *thread-implementations*))) (while impls ((car impls)) (println) (set impls (cdr impls)))) (println "int main() {") (println "    thread_context ctx = {0};") (println "    ctx.sp = ctx.stack;") (println "    oop result = " main-thread "(&ctx);") (println "    if (result) {") (println "        printf(\"Result: %ld\\n\", getLong(result));") (println "    } else {") (println "        printf(\"Result: nil\\n\");") (println "    }") (println "    return 0;") (println "}"))
[?7h[32m[?7lemit-c-threaded.l:263[0m (let ((ret-thread (c-gen-return-thread))) (let ((main-thread (compile-expression expr ret-thread))) (println "/* Forward declarations */") (let ((decls (my-reverse *thread-forward-decls*))) (while decls (println (car decls)) (set decls (cdr decls)))) (println) (println "/* Thread implementations */") (let ((impls (my-reverse *thread-implementations*))) (while impls ((car impls)) (println) (set impls (cdr impls)))) (println "int main() {") (println "    thread_context ctx = {0};") (println "    ctx.sp = ctx.stack;") (println "    oop result = " main-thread "(&ctx);") (println "    if (result) {") (println "        printf(\"Result: %ld\\n\", getLong(result));") (println "    } else {") (println "        printf(\"Result: nil\\n\");") (println "    }") (println "    return 0;") (println "}")))
[?7h[32m[?7ltest-threaded-meta.l:6[0m (compile-threaded (quote (if (long? x) x 0)))
[?7h