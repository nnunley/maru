;;; Working C backend test

(require "emit.l")
(require "emit-c.l")

;; Generate C headers and setup
(println "/* Generated by Maru C backend */")
(println "#include <stdio.h>")
(println "#include <stdlib.h>")
(println "#include <string.h>")
(println)
(println "typedef union Object *oop;")
(println "#define nil ((oop)0)")
(println "#define LONG(n) ((oop)(((long)(n) << 1) | 1))")
(println "#define getLong(x) ((long)(x) >> 1)")
(println)

;; Generate main function
(println "int main() {")
(println "  oop _acc = nil;")

;; Generate some C code using emit operations  
(emit LOAD (LI32 42))        ; _acc = LONG(42);
(emit NEG)                   ; _acc = LONG(-getLong(_acc));

(println "  printf(\"Result: %ld\\n\", getLong(_acc));")
(println "  return 0;")
(println "}")